<!DOCTYPE html>
<html lang="es">
<head>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Control de Gastos Hormiga - Christian Hern√°ndez S.</title>


   <!-- ========================= -->
    <!-- üî• INICIO: CONFIG PWA üî• -->
    <!-- ========================= -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">

    <link rel="icon" sizes="192x192" href="icon-192.png">
    <link rel="icon" sizes="512x512" href="icon-512.png">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Gastos Hormiga">
    <link rel="apple-touch-icon" href="icon-192.png">
    <!-- ========================= -->
    <!-- üî• FIN: CONFIG PWA üî• -->
    <!-- ========================= -->

    
    <style>
        /* --- CSS completo (id√©ntico al tuyo original) --- */
        * { margin:0; padding:0; box-sizing:border-box; }
        :root {
            --primary:#1e3a8a; --secondary:#3b82f6; --success:#22c55e;
            --warning:#f59e0b; --danger:#ef4444; --dark:#1f2937;
            --light:#f3f4f6; --white:#ffffff;
        }
        body {
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh; padding:20px; transition:background .3s;
        }
        body.dark-mode { background:linear-gradient(135deg,#1e3a8a 0%,#312e81 100%); }
        .container { max-width:1400px; margin:0 auto; background:var(--white); border-radius:20px;
            box-shadow:0 20px 60px rgba(0,0,0,.3); overflow:hidden; animation:slideIn .5s ease-out; }
        @keyframes slideIn { from{opacity:0; transform:translateY(30px);} to{opacity:1; transform:translateY(0);} }
        body.dark-mode .container { background:#1f2937; color:#f3f4f6; }
        .header { background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);
            color:white; padding:40px 30px; text-align:center; position:relative; overflow:hidden; }
        .header::before { content:''; position:absolute; top:-50%; right:-50%; width:200%; height:200%;
            background:radial-gradient(circle, rgba(255,255,255,.1) 0%, transparent 70%); animation:rotate 20s linear infinite; }
        @keyframes rotate { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
        .header h1{ font-size:2.8em; margin-bottom:10px; text-shadow:2px 2px 4px rgba(0,0,0,.2); position:relative; z-index:1; }
        .header p{ font-size:1.2em; opacity:.95; position:relative; z-index:1; }
        .demo-badge{ display:inline-block; background:rgba(255,255,255,.2); padding:8px 20px; border-radius:20px;
            margin-top:10px; font-size:.9em; backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.3); }
        .theme-toggle{ position:fixed; top:20px; right:20px; background:rgba(255,255,255,.2); border:none;
            padding:12px 24px; border-radius:25px; color:white; cursor:pointer; font-size:1em; transition:all .3s;
            backdrop-filter:blur(10px); z-index:1000; box-shadow:0 4px 15px rgba(0,0,0,.2); }
        .theme-toggle:hover{ background:rgba(255,255,255,.3); transform:scale(1.05); }
        .content{ padding:30px; }
        .section{ background:var(--light); border-radius:15px; padding:30px; margin-bottom:25px;
            box-shadow:0 4px 6px rgba(0,0,0,.1); transition:all .3s; }
        .section:hover{ box-shadow:0 8px 15px rgba(0,0,0,.15); transform:translateY(-2px); }
        body.dark-mode .section{ background:#374151; }
        .section h2{ color:var(--primary); margin-bottom:25px; font-size:2em; border-bottom:3px solid var(--secondary);
            padding-bottom:12px; display:flex; align-items:center; gap:10px; }
        body.dark-mode .section h2{ color:#60a5fa; }
        .form-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:20px; margin-bottom:20px; }
        .form-group{ display:flex; flex-direction:column; }
        .form-group label{ font-weight:600; margin-bottom:8px; color:var(--dark); font-size:.95em; }
        body.dark-mode .form-group label{ color:#e5e7eb; }
        .form-group input, .form-group select { padding:14px; border:2px solid #d1d5db; border-radius:10px; font-size:1em; transition:all .3s; background:white; }
        body.dark-mode .form-group input, body.dark-mode .form-group select { background:#4b5563; border-color:#6b7280; color:#f3f4f6; }
        .form-group input:focus, .form-group select:focus { outline:none; border-color:var(--secondary); box-shadow:0 0 0 4px rgba(59,130,246,.1); transform:translateY(-2px); }
        .btn { padding:14px 32px; border:none; border-radius:10px; font-size:1em; font-weight:600; cursor:pointer; transition:all .3s; text-transform:uppercase; letter-spacing:.5px; box-shadow:0 4px 6px rgba(0,0,0,.1); }
        .btn:active { transform:scale(.95); }
        .btn-primary { background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%); color:white; }
        .btn-primary:hover { transform:translateY(-3px); box-shadow:0 8px 25px rgba(59,130,246,.4); }
        .btn-success { background:linear-gradient(135deg,#16a34a 0%,var(--success) 100%); color:white; }
        .btn-success:hover { transform:translateY(-3px); box-shadow:0 8px 25px rgba(34,197,94,.4); }
        .btn-danger { background:linear-gradient(135deg,#dc2626 0%,var(--danger) 100%); color:white; }
        .btn-danger:hover { transform:translateY(-3px); box-shadow:0 8px 25px rgba(239,68,68,.4); }
        .budget-display{ display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:20px; margin-top:25px; }
        .budget-card{ background:white; padding:25px; border-radius:15px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,.1); border-left:6px solid var(--secondary); transition:all .3s; position:relative; overflow:hidden;}
        .budget-card::before{ content:''; position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, transparent 0%, rgba(59,130,246,.05) 100%); z-index:0; }
        .budget-card:hover{ transform:translateY(-5px); box-shadow:0 8px 20px rgba(0,0,0,.15); }
        body.dark-mode .budget-card{ background:#4b5563; }
        .budget-card.warning{ border-left-color:var(--warning); }
        .budget-card.danger{ border-left-color:var(--danger); animation:pulse 2s infinite; }
        @keyframes pulse { 0%,100{ transform:scale(1);} 50%{ transform:scale(1.03);} }
        .budget-card h3{ font-size:.9em; color:#6b7280; margin-bottom:12px; text-transform:uppercase; letter-spacing:1px; position:relative; z-index:1; }
        body.dark-mode .budget-card h3{ color:#9ca3af; }
        .budget-card .amount { font-size:2.2em; font-weight:bold; color:var(--primary); position:relative; z-index:1; }
        body.dark-mode .budget-card .amount{ color:#60a5fa; }
        .progress-bar{ width:100%; height:35px; background:#e5e7eb; border-radius:20px; overflow:hidden; margin:25px 0; position:relative; box-shadow:inset 0 2px 4px rgba(0,0,0,.1); }
        body.dark-mode .progress-bar{ background:#4b5563; }
        .progress-fill{ height:100%; background:linear-gradient(90deg,#16a34a 0%,var(--success) 100%); transition:all .8s ease; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:1.1em; position:relative; overflow:hidden; }
        .progress-fill::before{ content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg, transparent, rgba(255,255,255,.3), transparent); animation:shimmer 2s infinite; }
        @keyframes shimmer { to { left:100%; } }
        .progress-fill.warning{ background:linear-gradient(90deg,#d97706 0%,var(--warning) 100%); }
        .progress-fill.danger{ background:linear-gradient(90deg,#dc2626 0%,var(--danger) 100%); }
        .expense-list { margin-top:25px; }
        .expense-item { background:white; padding:20px; border-radius:12px; margin-bottom:12px; display:grid; grid-template-columns:auto 1fr auto auto; gap:20px; align-items:center; box-shadow:0 2px 6px rgba(0,0,0,.1); transition:all .3s; border-left:4px solid var(--secondary); }
        body.dark-mode .expense-item{ background:#4b5563; }
        .expense-item:hover{ transform:translateX(8px); box-shadow:0 6px 15px rgba(0,0,0,.15); }
        .expense-day{ background:linear-gradient(135deg,var(--secondary) 0%, #2563eb 100%); color:white; padding:10px 18px; border-radius:10px; font-weight:bold; text-align:center; min-width:90px; box-shadow:0 2px 8px rgba(59,130,246,.3); }
        .expense-details{ display:flex; flex-direction:column; gap:5px; }
        .expense-category{ font-size:1.05em; color:var(--dark); font-weight:700; }
        body.dark-mode .expense-category{ color:#e5e7eb; }
        .expense-description{ font-size:.9em; color:#6b7280; }
        body.dark-mode .expense-description{ color:#9ca3af; }
        .expense-amount{ font-size:1.5em; font-weight:bold; color:var(--danger); }
        .tips-container{ background:linear-gradient(135deg,#fef3c7 0%, #fde68a 100%); padding:25px; border-radius:15px; margin-top:25px; border-left:6px solid var(--warning); box-shadow:0 4px 10px rgba(245,158,11,.2); }
        body.dark-mode .tips-container{ background:linear-gradient(135deg,#78350f 0%, #92400e 100%); }
        .tips-container h3{ color:#92400e; margin-bottom:15px; font-size:1.3em; }
        body.dark-mode .tips-container h3{ color:#fde68a; }
        .tip-item{ padding:12px 15px; margin:8px 0; background:rgba(255,255,255,.6); border-radius:10px; transition:all .3s; border-left:3px solid #f59e0b; }
        .tip-item:hover{ background:rgba(255,255,255,.8); transform:translateX(5px); }
        body.dark-mode .tip-item{ background:rgba(0,0,0,.3); color:#fde68a; }
        .chart-container{ margin-top:25px; background:white; padding:25px; border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,.1); }
        body.dark-mode .chart-container{ background:#4b5563; }
        .alert{ padding:18px 25px; border-radius:12px; margin:20px 0; font-weight:600; display:flex; align-items:center; gap:12px; font-size:1.05em; box-shadow:0 4px 10px rgba(0,0,0,.1); }
        .alert-warning{ background:linear-gradient(135deg,#fef3c7 0%, #fde68a 100%); color:#92400e; border-left:6px solid var(--warning); }
        .alert-danger{ background:linear-gradient(135deg,#fee2e2 0%, #fecaca 100%); color:#991b1b; border-left:6px solid var(--danger); animation:shake .5s; }
        @keyframes shake { 0%,100%{ transform:translateX(0);} 25%{ transform:translateX(-10px);} 75%{ transform:translateX(10px);} }
        .savings-goal{ background:linear-gradient(135deg,#dcfce7 0%, #bbf7d0 100%); padding:25px; border-radius:15px; margin-top:25px; border-left:6px solid var(--success); box-shadow:0 4px 10px rgba(34,197,94,.2); }
        body.dark-mode .savings-goal{ background:linear-gradient(135deg,#14532d 0%, #166534 100%); }
        .savings-goal h3{ color:#166534; font-size:1.3em; margin-bottom:15px; }
        body.dark-mode .savings-goal h3{ color:#bbf7d0; }
        .day-selector{ display:flex; gap:12px; flex-wrap:wrap; margin:20px 0; }
        .day-btn{ padding:12px 24px; border:2px solid var(--secondary); background:white; border-radius:10px; cursor:pointer; transition:all .3s; font-weight:600; font-size:1em; box-shadow:0 2px 6px rgba(0,0,0,.1); }
        .day-btn:hover{ transform:translateY(-3px); box-shadow:0 4px 12px rgba(59,130,246,.3); }
        body.dark-mode .day-btn{ background:#4b5563; color:#f3f4f6; }
        .day-btn.active{ background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%); color:white; transform:scale(1.05); }
        .day-btn.weekend{ border-color:var(--warning); }
        .day-btn.weekend.active{ background:linear-gradient(135deg,#d97706 0%,var(--warning) 100%); }
        .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(180px,1fr)); gap:20px; margin:25px 0; }
        .stat-card{ background:white; padding:20px; border-radius:12px; text-align:center; box-shadow:0 4px 8px rgba(0,0,0,.1); transition:all .3s; border-top:4px solid var(--secondary); }
        .stat-card:hover{ transform:translateY(-5px); box-shadow:0 8px 20px rgba(0,0,0,.15); }
        body.dark-mode .stat-card{ background:#4b5563; }
        .stat-value{ font-size:1.8em; font-weight:bold; color:var(--secondary); margin:10px 0; }
        body.dark-mode .stat-value{ color:#60a5fa; }
        .stat-label{ font-size:.9em; color:#6b7280; text-transform:uppercase; letter-spacing:.5px; }
        body.dark-mode .stat-label{ color:#9ca3af; }
        .demo-alert{ background:linear-gradient(135deg,#dbeafe 0%, #bfdbfe 100%); border:2px solid #3b82f6; border-radius:12px; padding:15px 20px; margin-bottom:20px; display:flex; align-items:center; gap:12px; font-weight:500; color:#1e40af; }
        .demo-alert button{ margin-left:auto; padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:all .3s; }
        .demo-alert button:hover{ background:#2563eb; transform:scale(1.05); }
        @media (max-width:768px) {
            .header h1{ font-size:2em; }
            .expense-item{ grid-template-columns:1fr; gap:10px; }
            .day-selector{ gap:8px; }
            .day-btn{ padding:10px 16px; font-size:.9em; }
        }

/* Ocultar bot√≥n Descargar HTML */
button[onclick="exportToHTML()"] {
    display: none !important;
}




    </style>
</head>
<body>

<!-- Banner FESC Cuautitl√°n -->
<div style="width:100%; overflow:hidden; margin-bottom:20px;">
    <img src="banner-fesc.jpeg"
         alt="Banner FESC"
         style="
            width:100%;
            height:45vh;               /* altura flexible seg√∫n pantalla */
            object-fit:cover;
            object-position:top;       /* <-- Muestra la parte superior de la imagen */
            filter:brightness(0.95);
         ">
</div>



    
    

    <button class="theme-toggle" onclick="toggleTheme()">üåì Cambiar Tema</button>

    <div class="container" id="appRoot">
        <div class="header">
            <h1>üí∞ Control de Gastos Hormiga</h1>
            <p>Por Ing. Christian Hern√°ndez S. | UNAM-FESC4</p>
            <div class="demo-badge">‚ú® Versi√≥n con Ejemplo Precargado</div>
        </div>

        <div class="content">
           <div class="demo-alert" id="demoAlert">
    <span>‚ÑπÔ∏è <strong>Modo Demo:</strong> Esta aplicaci√≥n incluye datos de ejemplo. Puedes eliminarlos y empezar tu propio control.</span>

    <!-- LIMPIAR TODO -->
    <button onclick="clearAllData()">Limpiar y Empezar</button>

    <!-- NUEVO BOT√ìN EJEMPLO -->
    <button onclick="loadDemoExample()" style="margin-left:10px; background:#10b981;">
        Cargar Ejemplo
    </button>
</div>


            <!-- Configuraci√≥n Personal -->
            <div class="section">
                <h2>üìã Configuraci√≥n Personal</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre Completo:</label>
                        <input type="text" id="studentName" placeholder="Tu nombre">
                    </div>
                    <div class="form-group">
                        <label>Licenciatura:</label>
                        <input type="text" id="degree" placeholder="Tu carrera">
                    </div>
                    <div class="form-group">
                        <label>Fecha de Inicio:</label>
                        <input type="date" id="startDate">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveProfile()">üíæ Guardar Perfil</button>
            </div>

            <!-- Presupuesto -->
            <div class="section">
                <h2>üíµ Configuraci√≥n de Presupuesto Semanal</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Presupuesto Semanal Total:</label>
                        <input type="number" id="weeklyBudget" placeholder="1000" min="0" step="10">
                    </div>
                    <div class="form-group">
                        <label>Meta de Ahorro Semanal:</label>
                        <input type="number" id="savingsGoal" placeholder="200" min="0" step="10">
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="includeWeekend" onchange="toggleWeekend()">
                        ¬øEstudias fines de semana?
                    </label>
                </div>
                <button class="btn btn-primary" onclick="saveBudget()">‚úÖ Establecer Presupuesto</button>

                <div id="budgetDisplay" style="display:none;">
                    <div class="budget-display">
                        <div class="budget-card" id="totalBudgetCard">
                            <h3>Presupuesto Total</h3>
                            <div class="amount" id="totalBudgetAmount">$0</div>
                        </div>
                        <div class="budget-card" id="spentCard">
                            <h3>Gastado</h3>
                            <div class="amount" id="spentAmount">$0</div>
                        </div>
                        <div class="budget-card" id="remainingCard">
                            <h3>Disponible</h3>
                            <div class="amount" id="remainingAmount">$0</div>
                        </div>
                        <div class="budget-card" id="savingsCard">
                            <h3>Ahorro Proyectado</h3>
                            <div class="amount" id="savingsAmount">$0</div>
                        </div>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill">0%</div>
                    </div>

                    <div id="alertContainer"></div>
                </div>
            </div>

            <!-- Registrar Gasto -->
            <div class="section">
                <h2>üìù Registrar Gasto</h2>
                <div class="day-selector" id="daySelector"></div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Categor√≠a:</label>
                        <select id="category">
                            <option value="">Selecciona categor√≠a</option>
                            <option value="Transporte">üöå Transporte</option>
                            <option value="Comida">üçî Comida</option>
                            <option value="Caf√©s y Bebidas">‚òï Caf√©s y Bebidas</option>
                            <option value="Entretenimiento">üéÆ Entretenimiento</option>
                            <option value="Material Escolar">üìö Material Escolar</option>
                            <option value="Dulces">üçø Dulces</option>
                            <option value="Servicios">üì± Servicios (Internet, Tel.)</option>
                            <option value="Otros">üí∏ Otros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Monto:</label>
                        <input type="number" id="amount" placeholder="50.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n (opcional):</label>
                        <input type="text" id="description" placeholder="Ej: Uber a la universidad">
                    </div>
                </div>
                <button class="btn btn-success" onclick="addExpense()">‚ûï Agregar Gasto</button>
            </div>

            <!-- Estad√≠sticas -->
            <div class="section">
                <h2>üìä Estad√≠sticas de la Semana</h2>
                <div class="stats-grid" id="statsGrid"></div>
            </div>

            <!-- Meta Ahorro -->
            <div class="section">
                <div class="savings-goal" id="savingsGoalSection" style="display:none;">
                    <h3>üéØ Meta de Ahorro</h3>
                    <p>Meta: <strong id="goalAmount">$0</strong></p>
                    <p>Presupuesto Disponible: <strong id="projectedSavings">$0</strong></p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="savingsProgress">0%</div>
                    </div>
                </div>
            </div>

            <!-- Historial -->
            <div class="section">
                <h2>üìã Historial de Gastos</h2>
                <button class="btn btn-danger" onclick="clearExpenses()" style="float:right;">üóëÔ∏è Limpiar Todo</button>
                <div style="clear:both;"></div>
                <div class="expense-list" id="expenseList"></div>
            </div>

            <!-- Gr√°ficas -->
            <div class="section">
                <h2 id="analysisTitle">üìà An√°lisis Visual</h2>
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <!-- Tips -->
            <div class="section">
                <div class="tips-container">
                    <h3>üí° Tips Financieros Personalizados</h3>
                    <div id="tipsContainer"></div>
                </div>
            </div>

            <!-- Exportar -->
            <div class="section">
                <h2>üíæ Exportar Reporte</h2>
                <button class="btn btn-primary" onclick="exportToPDF()">üìÑ Descargar PDF (Historial)</button>
                <button class="btn btn-primary" onclick="exportToHTML()">üåê Descargar HTML</button>
            </div>
<!-- Imagen UNAM Posgrado -->
<div style="width:100%; text-align:center; margin-top:25px;">
    <img src="posgrado-unam.jpeg"
         alt="UNAM Posgrado"
         style="
            width:160px;          /* tama√±o peque√±o */
            height:auto;
            border-radius:20px;   /* bordes redondeados */
            box-shadow:0 4px 12px rgba(0,0,0,0.25); /* sombra elegante opcional */
            display:block;
            margin:auto;
        ">
</div>



        </div>
    </div>

    <!-- Dependencias CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

    <script>
        /***** Datos y utilidades *****/
        const LS_KEYS = {
            PROFILE: 'cg_profile',
            BUDGET: 'cg_budget',
            EXPENSES: 'cg_expenses',
            THEME: 'cg_theme'
        };

        let expenses = [];
        let selectedDay = null; // fecha ISO (yyyy-mm-dd)
        let dailyChart = null;
        let categoryChart = null;

        // Formatea moneda
        function fmtMoney(v){
            return '$' + Number(v||0).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits:2});
        }

        /***** localStorage helpers *****/
        function saveToLS(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
        function readFromLS(key){ const v = localStorage.getItem(key); return v ? JSON.parse(v) : null; }

        /***** Util: formatea "lun 10" con acentos donde corresponde *****/
        const SHORT_DAY_NAMES = ['dom','lun','mar','mi√©','jue','vie','s√°b'];



   
function shortDayNumFromIso(iso){
    const d = isoToLocalDate(iso);  // <<< CORRECCI√ìN IMPORTANTE
    const day = d.getDate().toString().padStart(2,'0');
    const wd = SHORT_DAY_NAMES[d.getDay()];
    return `${wd} ${day}`;
}







// Convierte 'YYYY-MM-DD' a Date local (evita desplazamientos de zona horaria)
function isoToLocalDate(iso){
    if(!iso) return null;
    const parts = iso.split('-').map(n => Number(n));
    // year, monthIndex (0-based), day
    return new Date(parts[0], parts[1]-1, parts[2]);
}



function isoAdd(dateObj, dayOffset){
    let d;
    if(typeof dateObj === 'string'){
        d = isoToLocalDate(dateObj);
    } else {
        d = new Date(dateObj);
    }
    d.setDate(d.getDate() + dayOffset);

    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
}














        /***** Carga general *****/
        function loadAll(){
            const profile = readFromLS(LS_KEYS.PROFILE);
            if(profile){
                document.getElementById('studentName').value = profile.name || '';
                document.getElementById('degree').value = profile.degree || '';
                document.getElementById('startDate').value = profile.startDate || '';
            }

            const budget = readFromLS(LS_KEYS.BUDGET);
            if(budget){
                document.getElementById('weeklyBudget').value = budget.weekly || '';
                document.getElementById('savingsGoal').value = budget.goal || '';
                document.getElementById('includeWeekend').checked = !!budget.includeWeekend;
                document.getElementById('budgetDisplay').style.display = 'block';
            }

            const theme = readFromLS(LS_KEYS.THEME);
            if(theme === 'dark') document.body.classList.add('dark-mode');

            expenses = readFromLS(LS_KEYS.EXPENSES) || [];

            // Si no hay fecha, poner hoy
            const sd = document.getElementById('startDate').value || new Date().toISOString().slice(0,10);
            document.getElementById('startDate').value = sd;

            const forceEmpty = sessionStorage.getItem("forceEmpty"); 

if(!expenses || expenses.length === 0){
    if(forceEmpty === "yes"){
        // No cargar demo
        expenses = [];
        saveToLS(LS_KEYS.EXPENSES, expenses);
    } else {
        // Cargar demo (comportamiento original)
        loadDemoData();
    }
}


            // Reconstruir todo
            buildDaySelector();
            renderExpenses();
            updateBudgetView();
            renderTips();
            renderCharts();
        }

        /***** Datos demo (si no hay) *****/


/***** Datos demo (si no hay) *****/
function loadDemoData(){
    // Fecha fija del ejemplo
    const fixedDate = "2026-02-09";  // 09/02/2026

    // PERFIL
    const demoProfile = { 
        name: 'Christian Hern√°ndez', 
        degree: 'I.M.E', 
        startDate: fixedDate
    };
    saveToLS(LS_KEYS.PROFILE, demoProfile);

    document.getElementById('studentName').value = demoProfile.name;
    document.getElementById('degree').value = demoProfile.degree;
    document.getElementById('startDate').value = fixedDate;

    // PRESUPUESTO DEMO
    const demoBudget = { weekly: 1200, goal: 300, includeWeekend: false };
    saveToLS(LS_KEYS.BUDGET, demoBudget);

    document.getElementById('weeklyBudget').value = demoBudget.weekly;
    document.getElementById('savingsGoal').value = demoBudget.goal;
    document.getElementById('includeWeekend').checked = demoBudget.includeWeekend;
    document.getElementById('budgetDisplay').style.display = 'block';

    // GENERAR GASTOS DEMO (fechas relativas a fixedDate)
    const base = isoToLocalDate(fixedDate);


    const demoExpenses = [
        { id: genId(), date: isoAdd(base, 0), category: 'Comida', amount: 95.2, description: 'Torta + Agua' },            // lun 04
        { id: genId(), date: isoAdd(base, 1), category: 'Transporte', amount: 24.5, description: 'Cami√≥n' },             // mar 05
        { id: genId(), date: isoAdd(base, 1), category: 'Caf√©s y Bebidas', amount: 30, description: 'Caf√©' },           // mar 05
        { id: genId(), date: isoAdd(base, 2), category: 'Servicios', amount: 49, description: 'Recarga' },               // mi√© 06
        { id: genId(), date: isoAdd(base, 3), category: 'Dulces', amount: 20, description: 'Gomitas' },                  // jue 07
        { id: genId(), date: isoAdd(base, 4), category: 'Comida', amount: 80, description: 'Comida corrida' },          // vie 08
        { id: genId(), date: isoAdd(base, 5), category: 'Entretenimiento', amount: 120, description: 'Cine' }           // s√°b 09 (si se incluye fin)
    ];

    saveToLS(LS_KEYS.EXPENSES, demoExpenses);
    expenses = demoExpenses;

    // ACTUALIZAR PANTALLA (asegura que el selector, lista y gr√°ficas se refresquen)
    buildDaySelector();
    renderExpenses();
    updateBudgetView();
    renderCharts();
}


    






        function genId(){ return 'e_' + Math.random().toString(36).slice(2,9); }

        /***** Guardar perfil y presupuesto *****/
        function saveProfile(){
            const profile = {
                name: document.getElementById('studentName').value.trim(),
                degree: document.getElementById('degree').value.trim(),
                startDate: document.getElementById('startDate').value
            };
            saveToLS(LS_KEYS.PROFILE, profile);
            selectedDay = null;
            buildDaySelector();
            renderExpenses();
            updateBudgetView();
            renderCharts();
            alert('Perfil guardado y d√≠as actualizados');
        }

        function saveBudget(){
            const weekly = Number(document.getElementById('weeklyBudget').value) || 0;
            const goal = Number(document.getElementById('savingsGoal').value) || 0;
            const includeWeekend = document.getElementById('includeWeekend').checked;
            const budget = { weekly, goal, includeWeekend };
            saveToLS(LS_KEYS.BUDGET, budget);
            document.getElementById('budgetDisplay').style.display = 'block';
            updateBudgetView();
            alert('Presupuesto guardado');
        }

        function toggleWeekend(){
            buildDaySelector();
            renderCharts();
        }

        function updateBudgetView(){
            const budget = readFromLS(LS_KEYS.BUDGET) || { weekly:0, goal:0, includeWeekend:false };
            const total = Number(budget.weekly || 0);
            const spent = expenses.reduce((s,e)=> s + Number(e.amount||0), 0);
            const remaining = Math.max(0, total - spent);
            const projectedSavings = Math.max(0, (budget.goal || 0) - Math.max(0, (budget.goal || 0) - remaining));

            document.getElementById('totalBudgetAmount').innerText = fmtMoney(total);
            document.getElementById('spentAmount').innerText = fmtMoney(spent);
            document.getElementById('remainingAmount').innerText = fmtMoney(remaining);
            document.getElementById('savingsAmount').innerText = fmtMoney(projectedSavings);

            const pct = total > 0 ? Math.round((spent/total) * 100) : 0;
            const fill = document.getElementById('progressFill');
            fill.style.width = pct + '%';
            fill.innerText = pct + '%';
            fill.className = 'progress-fill ' + (pct > 90 ? 'danger' : pct > 60 ? 'warning' : '');

            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = '';
            if(pct > 90) alertContainer.innerHTML = '<div class="alert alert-danger">‚ö†Ô∏è Has gastado m√°s del 90% de tu presupuesto semanal.</div>';
            else if(pct > 60) alertContainer.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Has gastado m√°s del 60% de tu presupuesto semanal.</div>';

            const savingsSection = document.getElementById('savingsGoalSection');
            if(budget.goal && budget.goal > 0){
                savingsSection.style.display = 'block';
                document.getElementById('goalAmount').innerText = fmtMoney(budget.goal);
                document.getElementById('projectedSavings').innerText = fmtMoney(Math.max(0, remaining));
                const spct = budget.goal > 0 ? Math.round((Math.max(0, remaining) / budget.goal) * 100) : 0;
                const sfill = document.getElementById('savingsProgress');
                sfill.style.width = spct + '%';
                sfill.innerText = spct + '%';
                sfill.className = 'progress-fill ' + (spct < 30 ? 'danger' : spct < 60 ? 'warning' : '');
            } else {
                savingsSection.style.display = 'none';
            }
        }

        /***** Selector de d√≠as (7 d√≠as desde fecha inicio) *****/
        function buildDaySelector(){
            const container = document.getElementById('daySelector');
            container.innerHTML = '';
            const profile = readFromLS(LS_KEYS.PROFILE) || {};
            const includeWeekend = document.getElementById('includeWeekend').checked || (readFromLS(LS_KEYS.BUDGET) || {}).includeWeekend;

            // fecha inicio EXACTA
            let start = profile.startDate ? isoToLocalDate(profile.startDate) : new Date();


            const prevSelected = selectedDay;

            for(let i=0;i<7;i++){
                const d = new Date(start);
                d.setDate(start.getDate() + i);
                const iso = d.toISOString().slice(0,10);
                const weekday = d.getDay();
                const isWeekend = (weekday === 0 || weekday === 6);
                if(!includeWeekend && isWeekend) continue;

                const btn = document.createElement('button');
                btn.className = 'day-btn' + (selectedDay===iso ? ' active' : '') + (isWeekend ? ' weekend' : '');
                // mostrar "lun 10" (con acentos)
                const dayLabel = shortDayNumFromIso(iso);
                btn.innerText = dayLabel;
                btn.onclick = ()=>{
                    selectedDay = iso;
                    document.querySelectorAll('.day-btn').forEach(b=>b.classList.remove('active'));
                    btn.classList.add('active');
                    renderCharts();
                    renderExpenses();
                };
                container.appendChild(btn);

                if(prevSelected === iso){
                    selectedDay = iso;
                    btn.classList.add('active');
                }
                if(!prevSelected && i===0){
                    selectedDay = iso;
                    btn.classList.add('active');
                }
            }

            if(!container.querySelector('.day-btn')){
                const d = new Date();
                const iso = d.toISOString().slice(0,10);
                const btn = document.createElement('button');
                btn.className = 'day-btn active';
                btn.innerText = shortDayNumFromIso(iso);
                btn.onclick = ()=>{ selectedDay = iso; document.querySelectorAll('.day-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderCharts(); renderExpenses(); };
                container.appendChild(btn);
                selectedDay = iso;
            }
        }

        /***** Agregar / eliminar gastos *****/
        function addExpense(){
            const cat = document.getElementById('category').value;
            const amt = Number(document.getElementById('amount').value) || 0;
            const desc = document.getElementById('description').value.trim();
            if(!cat || !amt || !selectedDay){ alert('Selecciona d√≠a, categor√≠a y monto v√°lido'); return; }

            const e = { id: genId(), date: selectedDay, category: cat, amount: Number(amt), description: desc };
            expenses.push(e);
            saveToLS(LS_KEYS.EXPENSES, expenses);
            renderExpenses();
            updateBudgetView();
            renderCharts();

            document.getElementById('category').value=''; document.getElementById('amount').value=''; document.getElementById('description').value='';
        }

        function deleteExpense(id){
            if(!confirm('¬øEliminar gasto?')) return;
            expenses = expenses.filter(x=> x.id !== id);
            saveToLS(LS_KEYS.EXPENSES, expenses);
            renderExpenses();
            updateBudgetView();
            renderCharts();
        }

        function clearExpenses(){
            if(!confirm('¬øBorrar todos los gastos?')) return;
            expenses = []; saveToLS(LS_KEYS.EXPENSES, expenses);
            renderExpenses(); updateBudgetView(); renderCharts();
        }

      function clearAllData(){
    if(!confirm('Esto eliminar√° TODO (perfil, presupuesto y gastos). ¬øContinuar?')) return;

    // evitar carga autom√°tica del demo
    sessionStorage.setItem("forceEmpty", "yes");

    // borrar datos
    localStorage.removeItem(LS_KEYS.PROFILE);
    localStorage.removeItem(LS_KEYS.BUDGET);
    localStorage.removeItem(LS_KEYS.EXPENSES);

    // recargar sin demo
    location.reload();
}


        /***** Render lista / stats *****/
        function renderExpenses(){
            const list = document.getElementById('expenseList');
            list.innerHTML = '';
            const sorted = expenses.slice().sort((a,b)=> a.date.localeCompare(b.date));
            sorted.forEach(e=>{
                const item = document.createElement('div'); item.className='expense-item';
                const day = document.createElement('div'); day.className='expense-day';
                
day.innerText = isoToLocalDate(e.date).toLocaleDateString(
    'es-MX',
    { weekday:'short', day:'2-digit', month:'short' }
);




                const details = document.createElement('div'); details.className='expense-details';
                const cat = document.createElement('div'); cat.className='expense-category'; cat.innerText = e.category;
                const desc = document.createElement('div'); desc.className='expense-description'; desc.innerText = e.description || '';
                details.appendChild(cat); details.appendChild(desc);
                const amt = document.createElement('div'); amt.className='expense-amount'; amt.innerText = fmtMoney(e.amount);
                const del = document.createElement('div'); del.innerHTML = '<button class="btn btn-danger" onclick="deleteExpense(\''+e.id+'\')">Eliminar</button>';
                item.appendChild(day); item.appendChild(details); item.appendChild(amt); item.appendChild(del);
                list.appendChild(item);
            });

            const statsGrid = document.getElementById('statsGrid'); statsGrid.innerHTML='';
            const total = expenses.reduce((s,e)=> s + Number(e.amount||0), 0);
            const byCat = {};
            expenses.forEach(e=> byCat[e.category] = (byCat[e.category]||0) + Number(e.amount||0));
            statsGrid.appendChild(statCard('Gasto Total', fmtMoney(total)));
            Object.keys(byCat).slice(0,6).forEach(k=> statsGrid.appendChild(statCard(k, fmtMoney(byCat[k]))));
        }

        function statCard(label, value){
            const c = document.createElement('div'); c.className='stat-card';
            c.innerHTML = '<div class="stat-value">'+value+'</div><div class="stat-label">'+label+'</div>';
            return c;
        }

        function renderTips(){
            const tips = [
                'Registra siempre el monto y la categor√≠a para identificar h√°bitos.',
                'Lleva efectivo justo para evitar compras impulsivas con tarjeta.',
                'Revisa tus gastos fijos y busca planes m√°s econ√≥micos para servicios.'
            ];
            const container = document.getElementById('tipsContainer'); container.innerHTML='';
            tips.forEach(t=>{ const d=document.createElement('div'); d.className='tip-item'; d.innerText=t; container.appendChild(d); });
        }

        /***** Gr√°ficas: usar solo los 7 d√≠as desde la fecha inicio y poner t√≠tulo "lun 10 - dom 16" *****/
        function renderCharts(){
            const profile = readFromLS(LS_KEYS.PROFILE) || {};
            if(!profile.startDate) return;
            const includeWeekend = document.getElementById('includeWeekend').checked || (readFromLS(LS_KEYS.BUDGET) || {}).includeWeekend;

            // construir array de 7 dias consecutivos desde start
            const start = isoToLocalDate(profile.startDate);

            const weekDays = [];
            for(let i=0;i<7;i++){
                const d = new Date(start);
                d.setDate(start.getDate() + i);
                const iso = d.toISOString().slice(0,10);
                const wd = d.getDay();
                const isWeekend = (wd===0 || wd===6);
                if(!includeWeekend && isWeekend) continue;
                weekDays.push(iso);
            }

            // filtrar gastos solo de esos dias
            const weekExpenses = expenses.filter(e => weekDays.includes(e.date));

            // agrupar por dia (incluir 0s en dias sin gasto)
            const groupByDay = {};
            weekDays.forEach(d => groupByDay[d] = 0);
            weekExpenses.forEach(e => { groupByDay[e.date] += Number(e.amount); });

            const dayLabels = weekDays.map(d => shortDayNumFromIso(d));
            const dayValues = weekDays.map(d => groupByDay[d]);

            // actualizar t√≠tulo del an√°lisis (ej: "lun 10 - dom 16")
            const analysisTitleEl = document.getElementById('analysisTitle');
            if(weekDays.length > 0){
                const first = shortDayNumFromIso(weekDays[0]);
                const last = shortDayNumFromIso(weekDays[weekDays.length-1]);
                analysisTitleEl.innerText = `üìà An√°lisis Visual ‚Äî ${first} - ${last}`;
            } else {
                analysisTitleEl.innerText = 'üìà An√°lisis Visual';
            }

            // daily chart
            if(dailyChart) dailyChart.destroy();
            const ctx = document.getElementById('dailyChart').getContext('2d');
            dailyChart = new Chart(ctx, {
                type:'bar',
                data:{
                    labels: dayLabels,
                    datasets:[{
                        label:'Gasto por d√≠a',
                        data: dayValues
                    }]
                },
                options:{ responsive:true, plugins:{ legend:{ display:false } } }
            });

            // categorias (solo dentro de la semana)
            const byCat = {};
            weekExpenses.forEach(e => byCat[e.category] = (byCat[e.category] || 0) + Number(e.amount));
            const catLabels = Object.keys(byCat);
            const catValues = catLabels.map(k => byCat[k]);

            if(categoryChart) categoryChart.destroy();
            const ctx2 = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(ctx2, {
                type:'pie',
                data:{ labels: catLabels, datasets:[{ data: catValues }] },
                options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
            });

            updateBudgetView();
        }

        /***** Exportar a HTML *****/
        function exportToHTML(){
            const doc = '<!doctype html>' + document.documentElement.outerHTML;
            const blob = new Blob([doc], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'control-gastos-hormiga.html'; document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        }

        /***** Exportar a PDF - Opci√≥n C: SOLO TABLA B√ÅSICA DEL HISTORIAL con t√≠tulo *****/
        function exportToPDF(){
            const profile = readFromLS(LS_KEYS.PROFILE) || {};
            const includeWeekend = document.getElementById('includeWeekend').checked || (readFromLS(LS_KEYS.BUDGET) || {}).includeWeekend;
            const start = profile.startDate ? isoToLocalDate(profile.startDate) : new Date();



            // construir los 7 dias desde start (mismas reglas que charts)
            const weekDays = [];
            for(let i=0;i<7;i++){
                const d = new Date(start);
                d.setDate(start.getDate() + i);
                const iso = d.toISOString().slice(0,10);
                const wd = d.getDay();
                const isWeekend = (wd===0 || wd===6);
                if(!includeWeekend && isWeekend) continue;
                weekDays.push(iso);
            }

            // gastos de esa semana
            const weekExpenses = expenses.slice().filter(e => weekDays.includes(e.date)).sort((a,b)=> a.date.localeCompare(b.date));

            // t√≠tulo: "Historial de gastos ‚Äî lun 10 - dom 16"
            let titleRange = '';
            if(weekDays.length > 0){
                titleRange = `${shortDayNumFromIso(weekDays[0])} - ${shortDayNumFromIso(weekDays[weekDays.length-1])}`;
            } else {
                titleRange = shortDayNumFromIso(new Date().toISOString().slice(0,10));
            }
            const titleText = `Historial de gastos ‚Äî ${titleRange}`;

            // Crear contenedor limpio para exportar
            const wrapper = document.createElement('div');
            wrapper.style.fontFamily = 'Arial, sans-serif';
            wrapper.style.padding = '18px';
            wrapper.style.color = '#111';

            const h = document.createElement('h2');
            h.innerText = titleText;
            h.style.marginBottom = '12px';
            wrapper.appendChild(h);

            // Tabla b√°sica
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.fontSize = '12px';

            const thead = document.createElement('thead');
            const trh = document.createElement('tr');
            ['D√≠a','Categor√≠a','Descripci√≥n','Monto'].forEach(thText=>{
                const th = document.createElement('th');
                th.innerText = thText;
                th.style.border = '1px solid #333';
                th.style.padding = '6px 8px';
                th.style.textAlign = 'left';
                th.style.background = '#f2f2f2';
                thead.appendChild(th);
            });
            thead.appendChild(trh);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            if(weekExpenses.length === 0){
                const trEmpty = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 4;
                td.innerText = 'No hay gastos en la semana seleccionada.';
                td.style.padding = '10px';
                td.style.border = '1px solid #333';
                trEmpty.appendChild(td);
                tbody.appendChild(trEmpty);
            } else {
                weekExpenses.forEach(e=>{
                    const tr = document.createElement('tr');
                    const tdDay = document.createElement('td');
                    tdDay.innerText = shortDayNumFromIso(e.date);
                    tdDay.style.padding = '6px 8px';
                    tdDay.style.border = '1px solid #333';
                    tr.appendChild(tdDay);

                    const tdCat = document.createElement('td');
                    tdCat.innerText = e.category || '';
                    tdCat.style.padding = '6px 8px';
                    tdCat.style.border = '1px solid #333';
                    tr.appendChild(tdCat);

                    const tdDesc = document.createElement('td');
                    tdDesc.innerText = e.description || '';
                    tdDesc.style.padding = '6px 8px';
                    tdDesc.style.border = '1px solid #333';
                    tr.appendChild(tdDesc);

                    const tdAmt = document.createElement('td');
                    tdAmt.innerText = fmtMoney(e.amount);
                    tdAmt.style.padding = '6px 8px';
                    tdAmt.style.border = '1px solid #333';
                    tdAmt.style.textAlign = 'right';
                    tr.appendChild(tdAmt);

                    tbody.appendChild(tr);
                });

                // fila total
                const total = weekExpenses.reduce((s,e)=> s + Number(e.amount||0), 0);
                const trTot = document.createElement('tr');
                const tdEmpty = document.createElement('td'); tdEmpty.colSpan = 3; tdEmpty.innerText = 'Total'; tdEmpty.style.padding='6px 8px'; tdEmpty.style.border='1px solid #333'; tdEmpty.style.fontWeight='700';
                const tdTot = document.createElement('td'); tdTot.innerText = fmtMoney(total); tdTot.style.padding='6px 8px'; tdTot.style.border='1px solid #333'; tdTot.style.textAlign='right'; tdTot.style.fontWeight='700';
                trTot.appendChild(tdEmpty); trTot.appendChild(tdTot);
                tbody.appendChild(trTot);
            }

            table.appendChild(tbody);
            wrapper.appendChild(table);

            // insertar en DOM temporalmente (necesario para html2pdf)
            wrapper.id = 'pdfExportWrapper';
            document.body.appendChild(wrapper);

            // Opciones html2pdf
            const opt = {
                margin:       0.4,
                filename:     `Historial_Gastos_${titleRange.replace(/\s+/g,'_')}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(wrapper).save().then(()=>{
                // borrar wrapper temporal
                setTimeout(()=>{ try{ wrapper.remove(); }catch(e){} }, 500);
            }).catch((err)=>{
                console.error('Error generando PDF', err);
                wrapper.remove();
                alert('Error al generar PDF. Revisa la consola.');
            });
        }

        /***** Tema *****/
        function toggleTheme(){ document.body.classList.toggle('dark-mode'); saveToLS(LS_KEYS.THEME, document.body.classList.contains('dark-mode')? 'dark':'light'); }

        /***** Inicializaci√≥n *****/
        window.addEventListener('load', ()=>{ loadAll(); });

        /***** Peque√±as mejoras: al cambiar la fecha en el input (antes de guardar) actualizamos selector visual sin persistir *****/
        document.addEventListener('DOMContentLoaded', ()=>{
            const sd = document.getElementById('startDate');
            if(sd){
                sd.addEventListener('change', ()=>{
                    // actualizar d√≠a visible (no guardamos en LS hasta que el usuario pulse Guardar)
                    const tmpProfile = { startDate: sd.value };
                    const prevProfile = readFromLS(LS_KEYS.PROFILE);
                    saveToLS(LS_KEYS.PROFILE, Object.assign({}, prevProfile || {}, tmpProfile));
                    selectedDay = null;
                    buildDaySelector();
                    renderExpenses();
                    renderCharts();
                    // restaurar LS profile (no sobrescribimos guardado real)
                    if(prevProfile) saveToLS(LS_KEYS.PROFILE, prevProfile);
                });
            }
        });
function loadDemoExample(){
    if(!confirm("¬øDeseas cargar el ejemplo pre-cargado? Se perder√°n tus datos actuales.")) return;
    loadDemoData();
    buildDaySelector();
    renderExpenses();
    updateBudgetView();
    renderCharts();
}

    </script>
<footer style="
    text-align:center;
    margin-top:40px;
    padding:20px;
    font-size:0.9em;
    color:#333;
    opacity:0.8;
">
    Universidad Nacional Aut√≥noma de M√©xico<br>
    Facultad de Estudios Superiores Cuautitl√°n<br>   
Este sitio es un proyecto acad√©mico sin fines de lucro.  
Im√°genes institucionales utilizadas √∫nicamente con fines educativos.<br>  
Desarrollado por Ing. Christian Hern√°ndez S. ‚Äî Todos los derechos reservados.<br>
 ¬© 2025 FESC-4, UNAM.



</footer>


</body>
</html>
 
